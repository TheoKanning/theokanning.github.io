<!DOCTYPE html>
<html>
<head>

    <!-- Document Settings -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- Base Meta -->
    <!-- dynamically fixing the title for tag/author pages -->



    <title>Mapping with the MIT Racecar</title>
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Styles'n'Scripts -->
    <link rel="stylesheet" type="text/css" href="/assets/built/screen.css" />
    <link rel="stylesheet" type="text/css" href="/assets/built/screen.edited.css" />
    <link rel="stylesheet" type="text/css" href="/assets/built/syntax.css" />
    <!-- highlight.js -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
    <style>.hljs { background: none; }</style>

    <!--[if IE]>
        <style>
            p, ol, ul{
                width: 100%;
            }
            blockquote{
                width: 100%;
            }
        </style>
    <![endif]-->
    
    <!-- This tag outputs SEO meta+structured data and other important settings -->
    <meta name="description" content="Science is Awesome" />
    <link rel="shortcut icon" href="https://theokanning.github.io/assets/images/global/favicon.png" type="image/png" />
    <link rel="canonical" href="https://theokanning.github.io/mapping-with-the-mit-racecar/" />
    <meta name="referrer" content="no-referrer-when-downgrade" />

     <!--title below is coming from _includes/dynamic_title-->
    <meta property="og:site_name" content="Theo Kanning" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Mapping with the MIT Racecar" />
    <meta property="og:description" content="Science is Awesome" />
    <meta property="og:url" content="https://theokanning.github.io/mapping-with-the-mit-racecar/" />
    <meta property="og:image" content="https://theokanning.github.io/" />
    <meta property="article:publisher" content="https://www.facebook.com/" />
    <meta property="article:tag" content="Robotics" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Mapping with the MIT Racecar" />
    <meta name="twitter:description" content="Science is Awesome" />
    <meta name="twitter:url" content="https://theokanning.github.io/" />
    <meta name="twitter:image" content="https://theokanning.github.io/" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Theo Kanning" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="Robotics" />
    <meta name="twitter:site" content="@theokanning" />
    <meta name="twitter:creator" content="@theokanning" />
    <meta property="og:image:width" content="2000" />
    <meta property="og:image:height" content="666" />

    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Website",
    "publisher": {
        "@type": "Organization",
        "name": "Theo Kanning",
        "logo": "https://theokanning.github.io/"
    },
    "url": "https://theokanning.github.io/mapping-with-the-mit-racecar/",
    "image": {
        "@type": "ImageObject",
        "url": "https://theokanning.github.io/",
        "width": 2000,
        "height": 666
    },
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://theokanning.github.io/mapping-with-the-mit-racecar/"
    },
    "description": "Science is Awesome"
}
    </script>

    <!-- <script type="text/javascript" src="https://demo.ghost.io/public/ghost-sdk.min.js?v=724281a32e"></script>
    <script type="text/javascript">
    ghost.init({
    	clientId: "ghost-frontend",
    	clientSecret: "f84a07a72b17"
    });
    </script> -->

    <meta name="generator" content="Jekyll 3.6.2" />
    <link rel="alternate" type="application/rss+xml" title="Mapping with the MIT Racecar" href="/feed.xml" />


</head>
<body class="post-template">

    <div class="site-wrapper">
        <!-- All the main content gets inserted here, index.hbs, post.hbs, etc -->
        <!-- default -->

<!-- The tag above means: insert everything in this file
into the {body} of the default.hbs template -->

<header class="site-header outer">
    <div class="inner">
        <nav class="site-nav">
    <div class="site-nav-left">
        
            
                <a class="site-nav-logo" href="https://theokanning.github.io/">Theo Kanning</a>
            
        
        
    </div>
    <div class="site-nav-right">
        <div class="social-links">
            
                <a class="social-link social-link-fb" href="https://linkedin.com/in/" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg>
</a>
            
            
                <a class="social-link social-link-tw" href="https://twitter.com/theokanning" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>
</a>
            
        </div>
        
    </div>
</nav>

    </div>
</header>

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

<main id="site-main" class="site-main outer" role="main">
    <div class="inner">

        <article class="post-full  tag-robotics  no-image">

            <header class="post-full-header">
                <section class="post-full-meta">
                    <time class="post-full-meta-date" datetime="19 August 2019">19 August 2019</time>
                    
                        <span class="date-divider">/</span>
                        
                            
                               <a href='/tag/robotics/'>ROBOTICS</a>
                            
                        
                    
                </section>
                <h1 class="post-full-title">Mapping with the MIT Racecar</h1>
            </header>

            

            <section class="post-full-content">
                <div class="kg-card-markdown">
                    <p>Now that the lidar works, it’s time to map my apartment! I made the map by driving the racecar around in teleop mode, recording the lidar with <code class="highlighter-rouge">rosbag</code>, and generating the map offline. Here’s how it works.</p>

<h2 id="lidar-preprocessing">Lidar Preprocessing</h2>

<p>In early iterations of my experiments, I noticed that the lidar recorded collisions with the racecar frame.
This led to the mapping algorithm leaving a little trail of obstacles as the racecar moved. Very unprofessional.</p>

<figure class="image">
    <img src="/assets/images/2019/mapping/lidar_interference.png" alt="Note the two sets of black dots in the open and the red lidar points on the robot" />
    <figcaption>Note the two sets of black dots in the open and the red lidar points on the robot</figcaption>
</figure>

<p><br /></p>

<p>To fix this, I added a box filter using the <a href="https://wiki.ros.org/laser_filters">laser_filters</a> package. A box filter removes any scans within a specific rectangle, so I filtered out all scans within the racecar itself. Then I updated the lidar node to publish to <code class="highlighter-rouge">scan_raw</code>, and created a filter node to read that topic and publish to <code class="highlighter-rouge">scan</code>.</p>

<p>Here are the changes I made:</p>

<figure class="highlight"><pre><code class="language-yml" data-lang="yml"><span class="c1"># sensors.yml</span>
<span class="na">laser_filter</span><span class="pi">:</span>
  <span class="na">tf_message_filter_target_frame</span><span class="pi">:</span> <span class="s">laser</span>
  <span class="na">scan_filter_chain</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">box</span>
    <span class="na">type</span><span class="pi">:</span> <span class="s">laser_filters/LaserScanBoxFilter</span>
    <span class="na">params</span><span class="pi">:</span>
      <span class="na">box_frame</span><span class="pi">:</span> <span class="s">base_link</span>
      <span class="na">min_x</span><span class="pi">:</span> <span class="s">-0.05</span>
      <span class="na">max_x</span><span class="pi">:</span> <span class="m">0.15</span>
      <span class="na">min_y</span><span class="pi">:</span> <span class="s">-0.15</span>
      <span class="na">max_y</span><span class="pi">:</span> <span class="m">0.15</span>
      <span class="na">min_z</span><span class="pi">:</span> <span class="s">-0.2</span>
      <span class="na">max_z</span><span class="pi">:</span> <span class="s">0.2</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"># sensors.launch.xml
<span class="c">&lt;!-- laser filter --&gt;</span>
<span class="nt">&lt;node</span> <span class="na">pkg=</span><span class="s">"laser_filters"</span> <span class="na">type=</span><span class="s">"scan_to_scan_filter_chain"</span> <span class="na">name=</span><span class="s">"laser_filter"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;remap</span> <span class="na">from=</span><span class="s">"scan"</span> <span class="na">to=</span><span class="s">"scan_raw"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;remap</span> <span class="na">from=</span><span class="s">"scan_filtered"</span> <span class="na">to=</span><span class="s">"scan"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/node&gt;</span></code></pre></figure>

<h2 id="gathering-data">Gathering Data</h2>

<p>Once the lidar data looked good, I recorded a run through my apartment to generate a map. High pitch angles can warp 2D lidar data, so I focused on making the robot move smoothly. I used <code class="highlighter-rouge">rosbag</code> to record the lidar data.</p>

<p><code class="highlighter-rouge">rosbag record -O apartment.bag /scan</code></p>

<p>I didn’t have to record the <code class="highlighter-rouge">tf</code> topic because the mapping launch file includes the static transform publishers. In fact, mapping failed when I recorded <code class="highlighter-rouge">tf</code> because the <code class="highlighter-rouge">laser_scan_matcher</code> needs to generate its own <code class="highlighter-rouge">odom</code> frame data.</p>

<h2 id="mapping">Mapping</h2>

<p>The actual mapping process uses three different packages: <a href="https://wiki.ros.org/laser_scan_matcher">laser_scan_matcher</a>, <a href="https://wiki.ros.org/hector_mapping">hector_mapping</a>, and <a href="http://%20http//wiki.ros.org/gmapping">gmapping</a>. Note that the static transforms are included too.</p>

<figure class="image">
    <img src="/assets/images/2019/mapping/rosgraph.png" alt="Note that the hector namespace only publishes frames" />
    <figcaption>Note that the hector namespace only publishes frames</figcaption>
</figure>

<p><br /></p>

<p>First, <code class="highlighter-rouge">laser_scan_matcher</code> compares the lidar scan history to estimate the robot’s movement and publish a <code class="highlighter-rouge">scan_match</code> frame. This works pretty well with just lidar even though the docs recommend adding an IMU or a separate odometry estimate.</p>

<p>Second, <code class="highlighter-rouge">hector_mapping</code> takes the lidar data and <code class="highlighter-rouge">scan_match</code> frame and creates its own odom estimate on the <code class="highlighter-rouge">hector_map</code> frame. This second layer creates a slightly better odometry estimate.</p>

<p>Last, <code class="highlighter-rouge">gmapping</code> takes the refined <code class="highlighter-rouge">hector_map</code> odometry estimate and generates a map from the lidar data. Using multiple mapping systems allows <code class="highlighter-rouge">gmapping</code> to work with a high quality odometry estimate and make the best map possible.<figure class="wp-block-image"></figure></p>

<figure class="image">
    <img src="/assets/images/2019/mapping/map.png" alt="My apartment look really weird from 10 inches off the ground" />
    <figcaption>My apartment look really weird from 10 inches off the ground</figcaption>
</figure>

<p><br /></p>

<h2 id="next-steps">Next Steps</h2>

<p>Even though I made a great map of my apartment, the mapping launch file still doesn’t use the IMU. Since it explicitly remaps the <code class="highlighter-rouge">imu</code> topic, I assume that updating it to use the IMU correctly is part of the actual MIT class. I keep seeing weird quirks like that in this repo, and I’m never sure what’s deliberate and what’s part of an assignment.</p>

<p>I considered getting rid of <code class="highlighter-rouge">hector_mapping</code> completely. The <code class="highlighter-rouge">laser_scan_matcher</code> seems to generate a great odometry estimate on its own, and <code class="highlighter-rouge">gmapping</code> works great by itself. Using fewer packages and tuning them better would be easier to understand too.</p>

<h2 id="notes-on-installing-packages">Notes on Installing Packages</h2>

<p>Most of the packages I used aren’t officially supported on Melodic yet (they all worked fine for me!), I had to clone their git repos and build them locally.</p>

<h3 id="hector_mapping-gmapping-and-laser_filters">hector_mapping, gmapping, and laser_filters</h3>

<p>The MIT racecar uses a combination of <code class="highlighter-rouge">hector_mapping</code> and <code class="highlighter-rouge">gmapping</code>, neither of which is officially supported on Melodic.</p>

<pre class="wp-block-preformatted">cd ~/racecar_ws
git clone https://github.com/ros-perception/slam_gmapping.git
git clone https://github.com/ros-perception/openslam_gmapping.git
git clone https://github.com/tu-darmstadt-ros-pkg/hector_slam.git
git clone https://github.com/ros-perception/laser_filters.git
cd ..
rosdep install --from-paths src --ignore-src -r -y</pre>

<h3 id="laser_scan_matcher">laser_scan_matcher</h3>

<p>I had to install <code class="highlighter-rouge">laser_scan_matcher</code> from source as well, and I built its csm dependency following the instructions <a href="https://github.com/ccny-ros-pkg/scan_tools/issues/63">here</a>.</p>

<pre class="wp-block-preformatted">cd ~/racecar_ws
git clone https://github.com/ccny-ros-pkg/scan_tools.git
git clone https://github.com/AndreaCensi/csm.git
cd csm
cmake -DCMAKE_INSTALL_PREFIX:PATH=/usr/local . 
make 
sudo make install</pre>

                </div>
            </section>

            <!-- Email subscribe form at the bottom of the page -->
            

            <footer class="post-full-footer">
                <!-- Everything inside the #author tags pulls data from the author -->
                <!-- #author-->
                
                    
                        <section class="author-card">
                            
                                <img class="author-profile-image" src="/assets/images/global/theo.png" alt="theo" />
                            
                            <section class="author-card-content">
                                <h4 class="author-card-name"><a href="/author/theo">Theo Kanning</a></h4>
                                
                                    <p>The best person</p>
                                
                            </section>
                        </section>
                        <div class="post-full-footer-right">
                            <a class="author-card-button" href="/author/theo">Read More</a>
                        </div>
                    
                
                <!-- /author  -->
            </footer>

            <!-- If you use Disqus comments, just uncomment this block.
            The only thing you need to change is "test-apkdzgmqhj" - which
            should be replaced with your own Disqus site-id. -->
            

        </article>

    </div>
</main>

<!-- Links to Previous/Next posts -->
<aside class="read-next outer">
    <div class="inner">
        <div class="read-next-feed">
            
                
                
                
                
                    <article class="read-next-card"
                        
                            
                        
                    >
                        <header class="read-next-card-header">
                            <small class="read-next-card-header-sitetitle">&mdash; Theo Kanning &mdash;</small>
                            
                                <h3 class="read-next-card-header-title"><a href="/tag/robotics/">Robotics</a></h3>
                            
                        </header>
                        <div class="read-next-divider"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 14.5s2 3 5 3 5.5-2.463 5.5-5.5S21 6.5 18 6.5c-5 0-7 11-12 11C2.962 17.5.5 15.037.5 12S3 6.5 6 6.5s4.5 3.5 4.5 3.5"/></svg>
</div>
                        <div class="read-next-card-content">
                            <ul>
                                
                                
                                  
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/using-the-rplidar-a1-on-the-mit-racecar/">Using the RPLIDAR A1 on the MIT Racecar</a></li>
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/mit-racecar-vesc-and-joystick-on-ubuntu-18-04/">MIT Racecar VESC and Joystick on Ubuntu 18.04</a></li>
                                        
                                    
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/mit-racecar-build/">MIT Racecar Build</a></li>
                                        
                                    
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                    
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                            </ul>
                        </div>
                        <footer class="read-next-card-footer">
                            <a href="/tag/robotics/">
                                
                                    See all 4 posts  →
                                
                            </a>
                        </footer>
                    </article>
                
            

            <!-- If there's a next post, display it using the same markup included from - partials/post-card.hbs -->
            

            <!-- If there's a previous post, display it using the same markup included from - partials/post-card.hbs -->
            
                

    <article class="post-card post-template no-image">
        
        <div class="post-card-content">
            <a class="post-card-content-link" href="/using-the-rplidar-a1-on-the-mit-racecar/">
                <header class="post-card-header">
                    
                        
                            
                                <span class="post-card-tags">Robotics</span>
                            
                        
                    

                    <h2 class="post-card-title">Using the RPLIDAR A1 on the MIT Racecar</h2>
                </header>
                <section class="post-card-excerpt">
                    
                        <p></p>
                    
                </section>
            </a>
            <footer class="post-card-meta">
                
                    
                        
                        <img class="author-profile-image" src="/assets/images/global/theo.png" alt="Theo Kanning" />
                        
                        <span class="post-card-author">
                            <a href="/author/theo/">Theo Kanning</a>
                        </span>
                    
                
                <span class="reading-time">
                    
                    
                      1 min read
                    
                </span>
            </footer>
        </div>
    </article>

            

        </div>
    </div>
</aside>

<!-- Floating header which appears on-scroll, included from includes/floating-header.hbs -->
<div class="floating-header">
    <div class="floating-header-logo">
        <a href="https://theokanning.github.io/">
            
            <span>Theo Kanning</span>
        </a>
    </div>
    <span class="floating-header-divider">&mdash;</span>
    <div class="floating-header-title">Mapping with the MIT Racecar</div>
    <div class="floating-header-share">
        <div class="floating-header-share-label">Share this <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M7.5 15.5V4a1.5 1.5 0 1 1 3 0v4.5h2a1 1 0 0 1 1 1h2a1 1 0 0 1 1 1H18a1.5 1.5 0 0 1 1.5 1.5v3.099c0 .929-.13 1.854-.385 2.748L17.5 23.5h-9c-1.5-2-5.417-8.673-5.417-8.673a1.2 1.2 0 0 1 1.76-1.605L7.5 15.5zm6-6v2m-3-3.5v3.5m6-1v2"/>
</svg>
</div>
        <a class="floating-header-share-tw" href="https://twitter.com/share?text=Mapping+with+the+MIT+Racecar&amp;url=mapping-with-the-mit-racecar/"
            onclick="window.open(this.href, 'share-twitter', 'width=550,height=235');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>

        </a>
        <a class="floating-header-share-fb" href="https://www.facebook.com/sharer/sharer.php?u=mapping-with-the-mit-racecar/"
            onclick="window.open(this.href, 'share-facebook','width=580,height=296');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M19 6h5V0h-5c-3.86 0-7 3.14-7 7v3H8v6h4v16h6V16h5l1-6h-6V7c0-.542.458-1 1-1z"/></svg>

        </a>
    </div>
    <progress class="progress" value="0">
        <div class="progress-container">
            <span class="progress-bar"></span>
        </div>
    </progress>
</div>


<!-- /post -->

<!-- The #contentFor helper here will send everything inside it up to the matching #block helper found in default.hbs -->


        <!-- Previous/next page links - displayed on every page -->
        

        <!-- The footer at the very bottom of the screen -->
        <footer class="site-footer outer">
            <div class="site-footer-content inner">
                <section class="copyright"><a href="https://theokanning.github.io/">Theo Kanning</a> &copy; 2020</section>
                <section class="poweredby">Proudly published with <a href="https://jekyllrb.com/">Jekyll</a> &
                    <a href="https://pages.github.com/" target="_blank" rel="noopener">GitHub Pages</a> using
                    <a href="https://github.com/jekyller/jasper2" target="_blank" rel="noopener">Jasper2</a></section>
                <nav class="site-footer-nav">
                    <a href="/">Latest Posts</a>
                    
                    <a href="https://twitter.com/theokanning" target="_blank" rel="noopener">Twitter</a>
                    <a href="https://ghost.org" target="_blank" rel="noopener">Ghost</a>
                </nav>
            </div>
        </footer>

    </div>

    <!-- The big email subscribe modal content -->
    

    <!-- highlight.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.10.0/components/prism-abap.min.js"></script>
    <script>$(document).ready(function() {
      $('pre code').each(function(i, block) {
        hljs.highlightBlock(block);
      });
    });</script>

    <!-- jQuery + Fitvids, which makes all video embeds responsive -->
    <script
        src="https://code.jquery.com/jquery-3.2.1.min.js"
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous">
    </script>
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="https://demo.ghost.io/assets/js/jquery.fitvids.js?v=724281a32e"></script>


    <!-- Paginator increased to "infinit" in _config.yml -->
    <!-- if paginator.posts  -->
    <!-- <script>
        var maxPages = parseInt('');
    </script>
    <script src="/assets/js/infinitescroll.js"></script> -->
    <!-- /endif -->

    


    <!-- Add Google Analytics  -->
    <!-- Google Analytics Tracking code -->
 <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', '', 'auto');
  ga('send', 'pageview');

 </script>


    <!-- The #block helper will pull in data from the #contentFor other template files. In this case, there's some JavaScript which we only want to use in post.hbs, but it needs to be included down here, after jQuery has already loaded. -->
    
        <script>

// NOTE: Scroll performance is poor in Safari
// - this appears to be due to the events firing much more slowly in Safari.
//   Dropping the scroll event and using only a raf loop results in smoother
//   scrolling but continuous processing even when not scrolling
$(document).ready(function () {
    // Start fitVids
    var $postContent = $(".post-full-content");
    $postContent.fitVids();
    // End fitVids

    var progressBar = document.querySelector('progress');
    var header = document.querySelector('.floating-header');
    var title = document.querySelector('.post-full-title');

    var lastScrollY = window.scrollY;
    var lastWindowHeight = window.innerHeight;
    var lastDocumentHeight = $(document).height();
    var ticking = false;

    function onScroll() {
        lastScrollY = window.scrollY;
        requestTick();
    }

    function onResize() {
        lastWindowHeight = window.innerHeight;
        lastDocumentHeight = $(document).height();
        requestTick();
    }

    function requestTick() {
        if (!ticking) {
            requestAnimationFrame(update);
        }
        ticking = true;
    }

    function update() {
        var trigger = title.getBoundingClientRect().top + window.scrollY;
        var triggerOffset = title.offsetHeight + 35;
        var progressMax = lastDocumentHeight - lastWindowHeight;

        // show/hide floating header
        if (lastScrollY >= trigger + triggerOffset) {
            header.classList.add('floating-active');
        } else {
            header.classList.remove('floating-active');
        }

        progressBar.setAttribute('max', progressMax);
        progressBar.setAttribute('value', lastScrollY);

        ticking = false;
    }

    window.addEventListener('scroll', onScroll, {passive: true});
    window.addEventListener('resize', onResize, false);

    update();
});
</script>

    

    <!-- Ghost outputs important scripts and data with this tag - it should always be the very last thing before the closing body tag -->
    <!-- ghost_foot -->

</body>
</html>
